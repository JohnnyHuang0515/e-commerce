# /ecommerce-system/nginx/dev.conf
# 開發環境專用 Nginx 設定檔

# CORS 處理 map
map $http_origin $cors_origin {
    default "";
    "~^https?://localhost(:[0-9]+)?$" $http_origin;
    "~^https?://127\.0\.0\.1(:[0-9]+)?$" $http_origin;
}

server {
    listen 80;
    server_name localhost;

    resolver 127.0.0.11;

    # 日誌設定
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 增加超時時間
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # CORS headers 由後端服務處理，不在 Nginx 層級設置

    # CORS 預檢請求由後端服務處理

    # API 代理規則
    # =============================================

    # Auth Service
    location /api/v1/auth/ {
        set $auth_service http://172.19.0.10:3002;
        proxy_pass $auth_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Auth Service - Users
    location /api/v1/users {
        set $auth_service http://auth-service:3002;
        proxy_pass $auth_service/api/v1/users;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Product Service
    location /api/v1/products/ {
        set $product_service http://ecommerce-product-service:3001;
        proxy_pass $product_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Product Service - Categories
    location /api/v1/categories {
        set $product_service http://product-service:3001;
        proxy_pass $product_service/api/v1/categories;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Product Service - Inventory
    location /api/v1/inventory {
        set $product_service http://product-service:3001;
        proxy_pass $product_service/api/v1/inventory;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Product Service - Stats
    location /api/v1/products/stats {
        set $product_service http://product-service:3001;
        proxy_pass $product_service/api/v1/products/stats;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # AI Service
    location /api/v1/ai/ {
        set $ai_service http://ai-service:3004;
        proxy_pass $ai_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Order Service
    location /api/v1/orders {
        set $order_service http://ecommerce-order-service:3003;
        proxy_pass $order_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Order Service - Payments
    location /api/v1/payments {
        set $order_service http://ecommerce-order-service:3003;
        proxy_pass $order_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Order Service - Logistics
    location /api/v1/logistics {
        set $order_service http://order-service:3003;
        proxy_pass $order_service/api/v1/logistics;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # System Service
    location /api/v1/system/ {
        set $system_service http://ecommerce-system-service:3005;
        proxy_pass $system_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # System Service Health Check
    location /api/v1/system-health {
        set $system_service http://system-service:3005;
        proxy_pass $system_service/api/v1/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Analytics Service
    location /api/v1/analytics/ {
        set $analytics_service http://ecommerce-analytics-service:3006;
        proxy_pass $analytics_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Analytics Service Health Check
    location /api/v1/analytics-health {
        set $analytics_service http://analytics-service:3006;
        proxy_pass $analytics_service/api/v1/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Dashboard Service
    location /api/v1/dashboard/ {
        set $dashboard_service http://ecommerce-dashboard-service:3008;
        proxy_pass $dashboard_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Dashboard Service - Overview (直接路由)
    location /overview {
        set $dashboard_service http://dashboard-service:3008;
        proxy_pass $dashboard_service/api/v1/dashboard/overview;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Dashboard Service Health Check
    location /api/v1/dashboard-health {
        set $dashboard_service http://dashboard-service:3008;
        proxy_pass $dashboard_service/api/v1/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Notification Service (暫時停用)
    # Notification Service (暫時停用 - 服務有問題)
    # location /api/v1/notifications/ {
    #     proxy_pass http://notification-service:3007/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    
    # location /api/v1/notifications-health {
    #     proxy_pass http://notification-service:3007/health;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # Log Service (暫時停用 - 服務有問題)
    # location /api/v1/logs/ {
    #     proxy_pass http://log-service:3008/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    
    # location /api/v1/logs-health {
    #     proxy_pass http://log-service:3008/health;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # Utility Service (暫時停用 - 服務有問題)
    # location /api/v1/utility/ {
    #     proxy_pass http://utility-service:3009/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    
    # location /api/v1/utility-health {
    #     proxy_pass http://utility-service:3009/health;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }

    # MinIO (File Storage) (暫時停用)
    # location /minio/ {
    #     proxy_pass http://minio-files:9000/;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # }

    # 前端開發伺服器代理
    # =============================================
    # 將所有其他請求轉發到在主機上運行的 Vite 開發伺服器
    # 在 Linux 環境中使用 host.docker.internal 可能不可用，改用主機 IP
    location / {
        set $frontend http://172.17.0.1:3000;
        proxy_pass $frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # WebSocket 支援
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
