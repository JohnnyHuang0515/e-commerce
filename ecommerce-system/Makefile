# ğŸ›’ é›»å•†ç³»çµ± Makefile

.PHONY: help dev stop build test clean deploy

# é è¨­ç›®æ¨™
help: ## é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
	@echo "ğŸ›’ é›»å•†ç³»çµ± - å¯ç”¨å‘½ä»¤"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# é–‹ç™¼ç’°å¢ƒ
dev: ## å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
	@echo "ğŸš€ å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ..."
	docker-compose up -d
	@echo "âœ… é–‹ç™¼ç’°å¢ƒå·²å•Ÿå‹•"
	@echo "ğŸ“Š ç›£æ§å„€è¡¨æ¿:"
	@echo "   - Grafana: http://localhost:3000"
	@echo "   - Prometheus: http://localhost:9090"
	@echo "   - Kibana: http://localhost:5601"

dev-build: ## å»ºæ§‹ä¸¦å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
	@echo "ğŸ”¨ å»ºæ§‹ä¸¦å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ..."
	docker-compose up -d --build
	@echo "âœ… é–‹ç™¼ç’°å¢ƒå·²å»ºæ§‹ä¸¦å•Ÿå‹•"

stop: ## åœæ­¢æ‰€æœ‰æœå‹™
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœå‹™..."
	docker-compose down
	@echo "âœ… æ‰€æœ‰æœå‹™å·²åœæ­¢"

restart: ## é‡æ–°å•Ÿå‹•æ‰€æœ‰æœå‹™
	@echo "ğŸ”„ é‡æ–°å•Ÿå‹•æ‰€æœ‰æœå‹™..."
	docker-compose restart
	@echo "âœ… æ‰€æœ‰æœå‹™å·²é‡æ–°å•Ÿå‹•"

# å»ºæ§‹ç›¸é—œ
build: ## å»ºæ§‹æ‰€æœ‰æœå‹™
	@echo "ğŸ”¨ å»ºæ§‹æ‰€æœ‰æœå‹™..."
	docker-compose build
	@echo "âœ… æ‰€æœ‰æœå‹™å·²å»ºæ§‹å®Œæˆ"

build-no-cache: ## å»ºæ§‹æ‰€æœ‰æœå‹™ (ä¸ä½¿ç”¨å¿«å–)
	@echo "ğŸ”¨ å»ºæ§‹æ‰€æœ‰æœå‹™ (ä¸ä½¿ç”¨å¿«å–)..."
	docker-compose build --no-cache
	@echo "âœ… æ‰€æœ‰æœå‹™å·²å»ºæ§‹å®Œæˆ"

# æ¸¬è©¦ç›¸é—œ
test: ## é‹è¡Œæ‰€æœ‰æ¸¬è©¦
	@echo "ğŸ§ª é‹è¡Œæ‰€æœ‰æ¸¬è©¦..."
	@echo "ğŸ“ å¾Œç«¯æ¸¬è©¦..."
	cd backend/services/product-service && npm test
	cd backend/services/order-service && npm test
	cd backend/services/user-service && npm test
	@echo "ğŸ“ AI æœå‹™æ¸¬è©¦..."
	cd backend/services/ai-search-service && python -m pytest
	cd ai-services/recommendation-service && python -m pytest
	cd ai-services/analytics-service && python -m pytest
	@echo "ğŸ“ å‰ç«¯æ¸¬è©¦..."
	cd frontend && npm test
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å·²å®Œæˆ"

test-unit: ## é‹è¡Œå–®å…ƒæ¸¬è©¦
	@echo "ğŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦..."
	npm run test:unit
	@echo "âœ… å–®å…ƒæ¸¬è©¦å·²å®Œæˆ"

test-integration: ## é‹è¡Œæ•´åˆæ¸¬è©¦
	@echo "ğŸ§ª é‹è¡Œæ•´åˆæ¸¬è©¦..."
	npm run test:integration
	@echo "âœ… æ•´åˆæ¸¬è©¦å·²å®Œæˆ"

test-e2e: ## é‹è¡Œç«¯åˆ°ç«¯æ¸¬è©¦
	@echo "ğŸ§ª é‹è¡Œç«¯åˆ°ç«¯æ¸¬è©¦..."
	npm run test:e2e
	@echo "âœ… ç«¯åˆ°ç«¯æ¸¬è©¦å·²å®Œæˆ"

# è³‡æ–™åº«ç›¸é—œ
db-migrate: ## åŸ·è¡Œè³‡æ–™åº«é·ç§»
	@echo "ğŸ—„ï¸ åŸ·è¡Œè³‡æ–™åº«é·ç§»..."
	cd backend/services/product-service && npm run migrate
	cd backend/services/order-service && npm run migrate
	cd backend/services/user-service && npm run migrate
	@echo "âœ… è³‡æ–™åº«é·ç§»å·²å®Œæˆ"

db-seed: ## åŸ·è¡Œè³‡æ–™åº«ç¨®å­
	@echo "ğŸŒ± åŸ·è¡Œè³‡æ–™åº«ç¨®å­..."
	cd backend/services/product-service && npm run seed
	cd backend/services/order-service && npm run seed
	cd backend/services/user-service && npm run seed
	@echo "âœ… è³‡æ–™åº«ç¨®å­å·²å®Œæˆ"

db-reset: ## é‡ç½®è³‡æ–™åº«
	@echo "ğŸ”„ é‡ç½®è³‡æ–™åº«..."
	docker-compose down -v
	docker-compose up -d mongodb postgres redis
	sleep 10
	$(MAKE) db-migrate
	$(MAKE) db-seed
	@echo "âœ… è³‡æ–™åº«å·²é‡ç½®"

# æ¸…ç†ç›¸é—œ
clean: ## æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œæ˜ åƒæª”
	@echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰å®¹å™¨å’Œæ˜ åƒæª”..."
	docker-compose down -v --rmi all
	docker system prune -f
	@echo "âœ… æ¸…ç†å®Œæˆ"

clean-logs: ## æ¸…ç†æ—¥èªŒæª”æ¡ˆ
	@echo "ğŸ§¹ æ¸…ç†æ—¥èªŒæª”æ¡ˆ..."
	find . -name "*.log" -delete
	@echo "âœ… æ—¥èªŒæª”æ¡ˆå·²æ¸…ç†"

# éƒ¨ç½²ç›¸é—œ
deploy-dev: ## éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
	@echo "ğŸš€ éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… é–‹ç™¼ç’°å¢ƒéƒ¨ç½²å®Œæˆ"

deploy-prod: ## éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
	@echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
	kubectl apply -f infrastructure/kubernetes/
	@echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆ"

# ç›£æ§ç›¸é—œ
monitor: ## å•Ÿå‹•ç›£æ§ç³»çµ±
	@echo "ğŸ“Š å•Ÿå‹•ç›£æ§ç³»çµ±..."
	docker-compose -f infrastructure/monitoring/docker-compose.yml up -d
	@echo "âœ… ç›£æ§ç³»çµ±å·²å•Ÿå‹•"
	@echo "ğŸ“Š ç›£æ§å„€è¡¨æ¿:"
	@echo "   - Grafana: http://localhost:3000"
	@echo "   - Prometheus: http://localhost:9090"
	@echo "   - Kibana: http://localhost:5601"

logs: ## æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹æ‰€æœ‰æœå‹™æ—¥èªŒ..."
	docker-compose logs -f

logs-product: ## æŸ¥çœ‹å•†å“æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹å•†å“æœå‹™æ—¥èªŒ..."
	docker-compose logs -f product-service

logs-order: ## æŸ¥çœ‹è¨‚å–®æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹è¨‚å–®æœå‹™æ—¥èªŒ..."
	docker-compose logs -f order-service

logs-user: ## æŸ¥çœ‹ç”¨æˆ¶æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹ç”¨æˆ¶æœå‹™æ—¥èªŒ..."
	docker-compose logs -f user-service

logs-ai-search: ## æŸ¥çœ‹AIæœå°‹æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹AIæœå°‹æœå‹™æ—¥èªŒ..."
	docker-compose logs -f ai-search-service

logs-log-service: ## æŸ¥çœ‹æ—¥èªŒæœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹æ—¥èªŒæœå‹™æ—¥èªŒ..."
	docker-compose logs -f log-service

logs-notification-service: ## æŸ¥çœ‹é€šçŸ¥æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹é€šçŸ¥æœå‹™æ—¥èªŒ..."
	docker-compose logs -f notification-service

logs-utility-service: ## æŸ¥çœ‹å·¥å…·æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹å·¥å…·æœå‹™æ—¥èªŒ..."
	docker-compose logs -f utility-service

# å¥åº·æª¢æŸ¥
health: ## æª¢æŸ¥æ‰€æœ‰æœå‹™å¥åº·ç‹€æ…‹
	@echo "ğŸ¥ æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹..."
	@echo "ğŸ“Š Product Service:"
	@curl -s http://localhost:3001/api/v1/health || echo "âŒ Product Service ç„¡å›æ‡‰"
	@echo "ğŸ“Š Order Service:"
	@curl -s http://localhost:3002/api/v1/health || echo "âŒ Order Service ç„¡å›æ‡‰"
	@echo "ğŸ“Š User Service:"
	@curl -s http://localhost:3003/api/v1/health || echo "âŒ User Service ç„¡å›æ‡‰"
	@echo "ğŸ“Š AI Search Service:"
	@curl -s http://localhost:3014/api/v1/health || echo "âŒ AI Search Service ç„¡å›æ‡‰"
	@echo "ğŸ“Š Notification Service:"
	@curl -s http://localhost:3017/api/v1/health || echo "âŒ Notification Service ç„¡å›æ‡‰"
	@echo "ğŸ“Š Log Service:"
	@curl -s http://localhost:3018/api/v1/health || echo "âŒ Log Service ç„¡å›æ‡‰"
	@echo "ğŸ“Š Utility Service:"
	@curl -s http://localhost:3019/api/v1/health || echo "âŒ Utility Service ç„¡å›æ‡‰"

# æ–‡æª”ç›¸é—œ
docs: ## ç”Ÿæˆ API æ–‡æª”
	@echo "ğŸ“š ç”Ÿæˆ API æ–‡æª”..."
	cd backend/services/product-service && npm run docs
	cd backend/services/order-service && npm run docs
	cd backend/services/user-service && npm run docs
	@echo "âœ… API æ–‡æª”å·²ç”Ÿæˆ"

docs-serve: ## å•Ÿå‹•æ–‡æª”æœå‹™å™¨
	@echo "ğŸ“š å•Ÿå‹•æ–‡æª”æœå‹™å™¨..."
	cd docs && python -m http.server 8080
	@echo "ğŸ“– æ–‡æª”æœå‹™å™¨: http://localhost:8080"

# å®‰å…¨ç›¸é—œ
security-scan: ## åŸ·è¡Œå®‰å…¨æƒæ
	@echo "ğŸ”’ åŸ·è¡Œå®‰å…¨æƒæ..."
	npm audit
	@echo "âœ… å®‰å…¨æƒæå®Œæˆ"

# æ€§èƒ½ç›¸é—œ
performance-test: ## åŸ·è¡Œæ€§èƒ½æ¸¬è©¦
	@echo "âš¡ åŸ·è¡Œæ€§èƒ½æ¸¬è©¦..."
	npm run test:performance
	@echo "âœ… æ€§èƒ½æ¸¬è©¦å®Œæˆ"

# å‚™ä»½ç›¸é—œ
backup: ## å‚™ä»½è³‡æ–™åº«
	@echo "ğŸ’¾ å‚™ä»½è³‡æ–™åº«..."
	./scripts/backup/backup-databases.sh
	@echo "âœ… è³‡æ–™åº«å‚™ä»½å®Œæˆ"

restore: ## é‚„åŸè³‡æ–™åº«
	@echo "ğŸ”„ é‚„åŸè³‡æ–™åº«..."
	./scripts/backup/restore-databases.sh
	@echo "âœ… è³‡æ–™åº«é‚„åŸå®Œæˆ"

# é–‹ç™¼å·¥å…·
install: ## å®‰è£æ‰€æœ‰ä¾è³´
	@echo "ğŸ“¦ å®‰è£æ‰€æœ‰ä¾è³´..."
	cd frontend && npm install
	cd backend/services/product-service && npm install
	cd backend/services/order-service && npm install
	cd backend/services/user-service && npm install
	cd backend/services/payment-service && npm install
	cd backend/services/ai-search-service && pip install -r requirements.txt
	cd ai-services/recommendation-service && pip install -r requirements.txt
	cd ai-services/analytics-service && pip install -r requirements.txt
	@echo "âœ… æ‰€æœ‰ä¾è³´å·²å®‰è£"

update: ## æ›´æ–°æ‰€æœ‰ä¾è³´
	@echo "ğŸ”„ æ›´æ–°æ‰€æœ‰ä¾è³´..."
	cd frontend && npm update
	cd backend/services/product-service && npm update
	cd backend/services/order-service && npm update
	cd backend/services/user-service && npm update
	cd backend/services/payment-service && npm update
	@echo "âœ… æ‰€æœ‰ä¾è³´å·²æ›´æ–°"

# å¿«é€Ÿå‘½ä»¤
quick-start: ## å¿«é€Ÿå•Ÿå‹• (å»ºæ§‹ + å•Ÿå‹• + ç¨®å­)
	@echo "ğŸš€ å¿«é€Ÿå•Ÿå‹•..."
	$(MAKE) build
	$(MAKE) dev
	@echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
	sleep 30
	$(MAKE) db-seed
	@echo "âœ… å¿«é€Ÿå•Ÿå‹•å®Œæˆ"

quick-stop: ## å¿«é€Ÿåœæ­¢
	@echo "ğŸ›‘ å¿«é€Ÿåœæ­¢..."
	$(MAKE) stop
	$(MAKE) clean-logs
	@echo "âœ… å¿«é€Ÿåœæ­¢å®Œæˆ"

# ç‹€æ…‹æª¢æŸ¥
status: ## æª¢æŸ¥æ‰€æœ‰æœå‹™ç‹€æ…‹
	@echo "ğŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹..."
	docker-compose ps
	@echo ""
	@echo "ğŸ”— API ç«¯é»:"
	@echo "   - Product Service: http://localhost:3001"
	@echo "   - Order Service: http://localhost:3002"
	@echo "   - User Service: http://localhost:3003"
	@echo "   - Search Service: http://localhost:3004"
	@echo "   - Frontend: http://localhost:3000"

# é–‹ç™¼è¼”åŠ©
shell-product: ## é€²å…¥å•†å“æœå‹™å®¹å™¨
	@echo "ğŸ³ é€²å…¥å•†å“æœå‹™å®¹å™¨..."
	docker-compose exec product-service sh

shell-order: ## é€²å…¥è¨‚å–®æœå‹™å®¹å™¨
	@echo "ğŸ³ é€²å…¥è¨‚å–®æœå‹™å®¹å™¨..."
	docker-compose exec order-service sh

shell-user: ## é€²å…¥ç”¨æˆ¶æœå‹™å®¹å™¨
	@echo "ğŸ³ é€²å…¥ç”¨æˆ¶æœå‹™å®¹å™¨..."
	docker-compose exec user-service sh

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help
